<!doctype html>
<!--
  DING Online main HTML shell: defines the core layout and loads styles/scripts.
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DING Online</title>
  <meta name="theme-color" content="#0b1020" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DING Online" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="shortcut icon" href="icon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="css/main.css" />
</head>
<body>
<header>
  <div class="row">
    <div class="title">
      <button class="logoBtn" id="homeIconBtn" type="button" aria-label="Back to menu">
        <img src="icon.svg" alt="" aria-hidden="true" />
      </button>
      <div>
        <div style="font-weight:900;font-size:16px;">DING Online</div>
        <div class="small"></div>
      </div>
    </div>
    <div class="row2">
      <div class="pill" id="phasePillWrap"><span>Phase:</span> <strong id="phasePill">LOBBY</strong></div>
      <div class="pill" id="trumpPillWrap"><span>Trump:</span> <strong id="trumpPill">‚Äî</strong></div>
      <div class="pill" id="leadPillWrap"><span>Lead suit:</span> <strong id="leadPill">‚Äî</strong></div>
    </div>
  </div>
  <div id="headerGreeting" class="small" style="margin-top:6px;display:none;"></div>
  <div id="notifier">
    <div id="notifierIcon" style="width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.03);font-size:20px;">?</div>
    <div style="flex:1;min-width:0;">
      <div id="notifierTitle" style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Status</div>
      <div id="notifierDetail" class="small" style="opacity:.9;">-</div>
    </div>
    <div id="notifierMeta" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <div id="notifierPlayer" class="pill" style="padding:6px 10px;border-radius:10px;">-</div>
      <div id="notifierAction" class="btn" style="padding:8px 10px;">-</div>
    </div>
  </div>
  <div id="headerTapZone" class="headerTapZone" aria-hidden="true"></div>
</header>
<div id="pwaPrompt" class="pwaPrompt" role="dialog" aria-live="polite" aria-hidden="true">
  <div class="pwaCard">
    <div class="pwaTitle" id="pwaPromptTitle">Install DING Online for turn alerts</div>
    <div class="small" id="pwaPromptBody">Add this game to your Home Screen so iPhone can send you turn notifications and open faster.</div>
    <div class="pwaSteps" id="pwaPromptSteps">
      <div class="pwaStep"><span class="pwaStepNum">1</span>Tap the Share button in Safari.</div>
      <div class="pwaStep"><span class="pwaStepNum">2</span>Tap More and select "Add to Home Screen".</div>
      <div class="pwaStep"><span class="pwaStepNum">3</span>Open the new app icon to enable alerts.</div>
    </div>
    <div id="pwaPromptStatus" class="pwaStatus" style="display:none;"></div>
    <div class="pwaActions">
      <button class="btn primary" id="pwaEnableBtn" type="button">Will do</button>
      <button class="btn" id="pwaDismissBtn" type="button">No thanks</button>
    </div>
  </div>
</div>
<div id="reconnectOverlay" class="reconnectOverlay" aria-live="assertive">
  <div class="reconnectCard">
    <div class="statusSpinner" aria-hidden="true"></div>
    <div style="font-weight:900;font-size:18px;">Reconnecting...</div>
    <div class="small" id="reconnectStatus">Trying to restore database access.</div>
    <button class="btn" id="offlineModeBtn" type="button">I want to play offline instead</button>
  </div>
</div>
<div id="fullscreenPopup" class="fullscreenPopup" aria-live="assertive">
  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <div class="popupCard" id="popupCard">
    <div class="popupTitle" id="popupTitle">YOU GOT DUNG</div>
    <div class="popupSubtitle" id="popupSubtitle"></div>
  </div>
</div>
<!-- Winner banner: shows when a player hits 0 -->
<div id="winnerBanner" class="panel" style="margin:12px auto;max-width:1100px;border-radius:12px;display:none;">
  <div class="bd" style="display:flex;align-items:center;gap:12px;padding:12px 14px;">
    <div id="winnerIcon">üèÜ</div>
    <div style="flex:1;min-width:0;">
      <div id="winnerTitle" style="font-weight:900;">Winner</div>
      <div id="winnerDetail" class="small" style="opacity:.9;">‚Äî</div>
    </div>
  </div>
</div>

<main>
  <div class="grid">
    <section id="gamePanel" class="panel">
      <div id="gameHeader" class="hd">
        <div id="gameTitle" style="font-weight:900;"><span class="caret" id="gameCaret">‚ñæ</span>Game Lobby</div>
        <div class="row2">
          <div id="gameSummary" class="small mono" style="margin-right:8px;">‚Äî</div>
          <button class="btn collapseBtn" id="collapseGameBtn">‚ñæ</button>
          <div class="menuWrap" id="roomMenuWrap">
            <button class="btn" id="roomMenuBtn" aria-expanded="false">More ‚ñæ</button>
            <div class="menu" id="roomMenu" role="menu">
              <button class="menuItem" id="menuBackLobbyBtn" type="button">Back to menu</button>
              <button class="menuItem" id="menuInviteRoomBtn" type="button">Invite to room</button>
              <button class="menuItem" id="menuEnableNotificationsBtn" type="button">Enable notifications</button>
              <div class="menuDivider" id="menuDivider" role="separator"></div>
              <button class="menuItem danger" id="menuResetBtn" type="button">Reset game</button>
              <button class="menuItem danger" id="menuResetHandBtn" type="button">Reset hand</button>
              <button class="menuItem danger" id="menuLeaveRoomBtn" type="button">Permanently leave room</button>
            </div>
          </div>
        </div>
      </div>
        <div class="bd stack">
          <div id="lobbyArea" class="stack">
            <div id="lobbyHotseatIntro" class="small">Enter 2-6 player names (one per line). Then start.</div>
            <textarea id="namesInput" class="input" rows="6" placeholder="Player 1&#10;Player 2&#10;Player 3"></textarea>
            <div class="modeCard" id="modeCard">
              <div class="small" style="margin-bottom:8px;">Game mode</div>
              <div class="modeRow">
              <button class="modeBtn active" id="modeHotseatBtn">Hotseat</button>
              <button class="modeBtn" id="modeMultiBtn">Multiplayer</button>
            </div>
            <div class="mpStatus" id="modeHint">Hotseat runs on one device. Multiplayer requires Google sign-in.</div>
          </div>
          <div class="mpCard" id="mpCard" style="display:none;">
            <div class="small" style="margin-bottom:8px;">Multiplayer</div>
            <div class="mpRow" style="margin-bottom:8px;">
              <button class="btn" id="signInBtn">Sign in with Google</button>
              <button class="btn danger" id="signOutBtn" style="display:none;">Sign out</button>
              <div class="mpStatus" id="authStatus">Not signed in.</div>
            </div>
            <div class="mpRow" id="nicknameRow" style="margin-bottom:8px; display:none;">
              <input class="input" id="nicknameInput" placeholder="Nickname in this room" maxlength="18" />
              <button class="btn" id="saveNicknameBtn">Save nickname</button>
            </div>
            <div class="mpStatus mpHint" id="nicknameStatus" style="display:none;"></div>
            <div class="mpDivider" id="nicknameDivider"></div>
            <div class="mpRow" id="roomNameRow" style="margin-bottom:8px; display:none;">
              <input class="input" id="roomNameInput" placeholder="Room name" maxlength="32" />
              <button class="btn" id="saveRoomNameBtn">Save room name</button>
            </div>
            <div class="mpStatus mpHint" id="roomNameStatus" style="display:none;"></div>
            <div class="mpDivider" id="roomNameDivider"></div>
              <div class="mpRow" style="margin-bottom:8px;">
                <input class="input mpCode" id="roomCodeInput" placeholder="ROOM CODE" style="display:none;" />
                <button class="btn primary" id="createRoomBtn">Create Room</button>
                <button class="btn" id="joinRoomBtn">Join Room</button>
                <button class="btn" id="shareRoomBtn">Copy/Share</button>
              </div>
            <div class="mpStatus" id="roomStatus">No room joined.</div>
            <div class="roomLobbyCard" id="roomLobbyCard" style="display:none;">
              <div class="roomLobbyTitle" id="roomLobbyTitle">Room</div>
              <div class="small" id="roomLobbySub">‚Äî</div>
              <div id="lobbyPlayers" class="lobbyList"></div>
              <div class="lobbyChatSlot" id="lobbyChatSlot"></div>
            </div>
          </div>
          <div id="roomListSection" class="roomListSection" style="display:none;">
            <div class="small" style="margin-bottom:6px;">Your rooms</div>
            <div id="roomList" class="roomList"></div>
            <div id="roomListEmpty" class="small" style="display:none;">No rooms yet.</div>
          </div>
          <div class="startActions" id="startActions">
            <button class="btn primary" id="startGameBtn">Start Game</button>
            <div class="voteStartBlock" id="voteStartBlock" style="display:none;">
              <button class="btn" id="voteStartBtn">Vote to start</button>
              <div class="small mono voteStartStatus" id="voteStartStatus">0/0 voted</div>
            </div>
          </div>
        </div>

        <div id="settingsCard" class="settingsCard">
          <div class="settingsHeader" id="settingsHeader" tabindex="0">
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="caret" id="settingsCaret">‚ñæ</span>
              <div style="font-weight:900;">Game settings</div>
              <span id="settingsLockPill" class="pill" style="padding:4px 8px;border-radius:10px;font-size:11px;display:none;">Locked</span>
            </div>
          </div>
          <div class="settingsBody" id="settingsBody">
            <div class="settingRow">
              <div>
                <div class="settingLabel">Starting Score</div>
                <div class="settingMeta">5‚Äì50</div>
              </div>
              <div class="settingControls">
                <input id="startingScoreInput" type="range" min="5" max="50" step="1" value="20" />
                <div class="settingValue" id="startingScoreValue">20</div>
              </div>
            </div>
            <div class="settingRow">
              <div>
                <div class="settingLabel">DING Penalty</div>
                <div class="settingMeta">0 tricks in a hand</div>
              </div>
              <div class="settingValue">Reset to start</div>
            </div>
            <div class="settingRow">
              <div>
                <div class="settingLabel">Leader Fold Threshold</div>
                <div class="settingMeta">1‚ÄìStarting Score</div>
              </div>
              <div class="settingControls">
                <input id="foldThresholdInput" type="range" min="1" max="20" step="1" value="5" />
                <div class="settingValue" id="foldThresholdValue">5</div>
              </div>
            </div>
            <div class="settingRow">
              <div>
                <div class="settingLabel">Leader Fold Penalty</div>
                <div class="settingMeta">On fold below threshold</div>
              </div>
              <div class="settingValue">Reset to threshold</div>
            </div>
            <div class="settingRow">
              <div>
                <div class="settingLabel">Amount of Decks</div>
                <div class="settingMeta">1‚Äì2</div>
              </div>
              <div class="settingControls">
                <input id="deckCountInput" type="range" min="1" max="2" step="1" value="1" />
                <div class="settingValue" id="deckCountValue">1</div>
              </div>
            </div>
            <div class="settingRow">
              <div>
                <div class="settingLabel">Hyperrealistic Mode</div>
                <div class="settingMeta">No handholding</div>
              </div>
              <label class="settingToggle">
                <input id="hyperrealisticInput" type="checkbox" />
                OFF
              </label>
            </div>
          </div>
        </div>

        <div id="controlsArea" class="stack" style="display:none;">
          <div class="scoreboard" id="scoreboard"></div>
          <div id="gameOverActions" class="panel" style="display:none;">
            <div class="bd" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <div class="small" id="gameOverHint">Game over.</div>
              <button class="btn good" id="newGameBtn">Start New Game</button>
            </div>
          </div>

          <div id="statusBox" class="pill" style="justify-content:space-between;">
            <span id="statusText">‚Äî</span>
            <span class="mono" id="deckText"></span>
          </div>
          <div id="logCard" class="logCard collapsed">
            <div class="logHeader" id="logHeader" role="button" tabindex="0" aria-expanded="false">
              <span class="logCaret" id="logCaret">‚ñæ</span>
              <div style="font-weight:800;">Room log</div>
              <div class="small" id="logHint" style="margin-left:auto;color:var(--muted);">Collapsed</div>
            </div>
            <div class="logBody" id="logBody">
              <div class="logList" id="logList"></div>
            </div>
          </div>
          <div id="errorBox" class="error" style="display:none;"></div>
        </div>
      </section>

    <section id="tablePanel" class="panel">
      <div id="tableHeader" class="hd">
        <div style="font-weight:900;"><span class="caret" id="tableCaret">‚ñæ</span>Table</div>
        <div class="row2">
          <div id="tableSummary" class="small mono" style="margin-right:8px;">‚Äî</div>
          <button class="btn collapseBtn" id="collapseTableBtn">‚ñæ</button>
          <div class="tableChips" id="tableChips">
            <div class="badge">Turn: <strong id="turnName">‚Äî</strong></div>
            <div class="badge">Dealer: <strong id="dealerName">‚Äî</strong></div>
            <div class="badge">Trick: <strong id="trickNum">‚Äî</strong></div>
          </div>
        </div>
      </div>
      <div class="bd tableArea" id="tableArea">
        <div class="trickArea" id="trickArea"></div>
        <div class="tableHint" id="tableHint" style="display:none;"></div>
        <div class="swapSummary" id="swapSummary" style="display:none;">
          <div class="swapSummaryTitle">Swaps:</div>
          <div class="swapSummaryList" id="swapSummaryList"></div>
        </div>
        <div class="swapAnnouncement" id="swapAnnouncement" style="display:none;" aria-live="polite">
          <div class="swapCardRow" id="swapAnnouncementCards"></div>
          <div class="swapAnnouncementText" id="swapAnnouncementText"></div>
        </div>

        <div id="handPanel" class="panel" style="border-radius:18px;">
          <div id="handHeader" class="hd">
            <div style="font-weight:900;">Your hand</div>
            <div class="row2">
              <div id="handSummary" class="small mono" style="margin-right:8px;">‚Äî</div>
              <button class="btn collapseBtn" id="collapseHandBtn">‚ñæ</button>
              <div style="display:flex; gap:8px; align-items:center;">
                <div class="badge" id="selectedBadge" style="display:none;">Selected: <strong id="selectedCount">0</strong></div>
                <button class="btn swap" id="confirmSwapBtn" style="display:none;">Swap</button>
                <button class="btn primary" id="confirmPlayBtn" style="display:none;">Play selected card</button>
                <button class="btn primary" id="startHandBtn">Deal Hands</button>
                <!-- Pass button removed -->
                <div id="autoPassViz" style="display:none;align-items:center;gap:8px;">
                  <div class="autoPassRing" id="autoPassRing">3</div>
                  <div class="small" id="autoPassLabel" style="white-space:nowrap;color:var(--muted);">Auto-pass</div>
                </div>
                <button class="btn" id="passBtn" style="display:none;">Pass</button>
                <button class="btn danger" id="foldBtn" style="display:none;">Fold</button>
              </div>
            </div>
          </div>
          <div class="bd">
            <div class="small" id="handHint">Start a hand to see cards.</div>
            <div class="hand" id="handArea"></div>
          </div>
        </div>

        <div class="chatBlock" id="chatBlock">
          <div class="chatHeader">
            <span>Room chat</span>
            <span class="small" id="chatHint">Multiplayer only</span>
          </div>
          <div class="chatList" id="chatList"></div>
          <div class="chatComposer">
            <input id="chatInput" type="text" maxlength="240" placeholder="Send a message to the room..." />
            <button class="btn primary" id="chatSendBtn" type="button">Send</button>
          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<div class="menu playerMenu" id="playerMenu" role="menu">
  <button class="menuItem" id="playerMenuChangeNameBtn" type="button">Change name</button>
  <div class="menuField" id="playerMenuNameRow" style="display:none;">
    <input class="input menuInput" id="playerMenuNameInput" placeholder="Nickname in this room" maxlength="18" />
    <button class="btn primary menuSaveBtn" id="playerMenuSaveNameBtn" type="button">Save name</button>
  </div>
  <div class="menuDivider" id="playerMenuNameDivider" style="display:none;"></div>
  <button class="menuItem" id="playerMenuMakeHostBtn" type="button">Make host</button>
  <button class="menuItem danger" id="playerMenuKickBtn" type="button">Kick</button>
</div>

<div class="lock" id="lock">
  <div class="box">
    <h2 id="lockTitle">Pass the device</h2>
    <p id="lockText">Hand is hidden. Give the device to the next player, then tap reveal.</p>
    <div class="row2">
      <button class="btn primary" id="revealBtn" style="flex:1;">Reveal</button>
    </div>
    <div class="footerNote">No peeking üëÄ</div>
  </div>
</div>
<div id="footerDebug" class="footerDebug">
  <div id="commitHash" class="commitHash"></div>
  <div id="debugLog" class="debugLog"></div>
</div>

<script src="firebase-config.js"></script>
  <script type="module" src="js/app.js"></script>
</body>
</html>
